# 家庭糖度健康管理系统

一个基于OpenCV和PyQt5的人脸识别家庭糖度健康管理系统，支持用户注册、人脸训练、实时识别和健康记录管理。

## 🎯 系统特性

- 🎯 **高精度人脸检测**：使用优化的Haar级联分类器
- 🧠 **智能人脸识别**：基于LBPH算法的改进识别器
- 📊 **数据增强训练**：自动生成多种变体提高模型鲁棒性
- 🖥️ **现代化UI界面**：基于PyQt5的用户友好界面
- 💾 **数据持久化**：SQLite数据库存储用户信息
- 📈 **健康管理**：糖分摄入记录和监控
- 🔄 **增量训练**：支持添加新用户而不影响现有模型

## 🚀 快速开始

### 0. 下载必要的模型文件（重要！）

在开始使用之前，您需要先下载dlib的预训练模型文件：

```bash
python download_models.py
```

这个脚本会自动下载：
- `shape_predictor_68_face_landmarks.dat` - 68点人脸特征点模型
- `dlib_face_recognition_resnet_model_v1.dat` - 人脸编码模型

**注意：** 这些文件较大（约100MB），下载可能需要一些时间。

### 1. 安装依赖

```bash
pip install -r requirements.txt
```

### 2. 运行主程序

```bash
python main.py
```

## 📚 详细使用指南

### 方式1：使用Qt界面（推荐）

1. **启动主程序**
   ```bash
   python main.py
   ```

2. **添加用户**
   - 点击"添加用户"按钮
   - 输入姓名、年龄、性别

3. **训练用户**
   - 点击"开始训练"按钮
   - 选择要训练的用户
   - 在训练对话框中采集人脸样本（至少5个）
   - 点击"开始训练"完成训练

4. **识别人脸**
   - 启动摄像头
   - 点击"开始识别"
   - 系统会自动检测和识别人脸

### 方式2：使用命令行训练

1. **从目录训练（推荐）**
   ```bash
   python train_faces.py
   # 选择选项1：从目录训练
   # 输入图片目录路径和用户信息
   ```

2. **从摄像头训练**
   ```bash
   python train_faces.py
   # 选择选项2：从摄像头训练
   # 输入用户姓名和样本数量
   ```

3. **查看现有用户**
   ```bash
   python train_faces.py
   # 选择选项3：查看现有用户
   ```

## 🔧 训练流程详解

### 1. 数据收集
- **Qt界面**：通过摄像头实时采集
- **命令行**：从指定目录读取图片
- **自动保存**：所有人脸图片自动保存到 `data/faces/用户名/` 目录

### 2. 数据预处理
- 人脸检测和提取
- 图像大小调整（150x150）
- 直方图均衡化
- 数据增强（旋转、亮度、对比度调整）

### 3. 模型训练
- 使用OpenCV LBPH算法
- 自动创建标签映射
- 保存模型到 `data/models/face_recognizer.yml`
- 保存标签映射到 `data/models/face_recognizer_labels.pkl`

### 4. 数据库关联
- 用户信息保存到 `users` 表
- 人脸图片路径保存到 `face_images` 表
- 建立完整的用户-图片-模型关联

## 📁 项目结构

```
face/
├── main.py                 # 主程序入口
├── train_faces.py          # 人脸训练脚本
├── download_models.py      # 模型下载脚本
├── requirements.txt        # 依赖包列表
├── database/              # 数据库相关
│   ├── database_manager.py
│   └── face_recognition.db
├── face_recognition/      # 人脸识别核心模块
│   ├── face_detector.py   # 人脸检测
│   ├── face_recognizer.py # 人脸识别
│   └── face_trainer.py    # 模型训练
├── ui/                    # Qt界面模块
│   └── main_window.py     # 主界面
├── models/                # 数据模型
│   └── user.py
├── utils/                 # 工具函数
│   └── config.py
├── data/                  # 数据存储
│   ├── faces/            # 人脸图片存储目录
│   │   └── 用户名/       # 每个用户一个目录
│   └── models/           # 模型文件存储
│       ├── face_recognizer.yml
│       └── face_recognizer_labels.pkl
└── config/               # 配置文件
    └── config.yaml
```

## ⚙️ 配置说明

配置文件位于 `config/config.yaml`，主要参数：

### 摄像头设置
- **device_id**: 摄像头设备ID（默认0）
- **width/height**: 视频分辨率（默认640x480）
- **fps**: 帧率（默认30）

### 人脸检测设置
- **model_path**: Haar级联分类器路径
- **min_face_size**: 最小人脸尺寸（默认50x50）
- **scale_factor**: 图像缩放因子（默认1.05）
- **min_neighbors**: 最小邻居数（默认6）

### 人脸识别设置
- **tolerance**: LBPH置信度阈值（默认100）
- **face_size**: 人脸图像尺寸（默认150x150）
- **min_samples**: 最小训练样本数（默认10）

### 训练设置
- **samples_per_person**: 每人样本数（默认25）
- **data_augmentation**: 是否启用数据增强（默认true）

## 📊 识别效果优化

### 图像预处理
- 直方图均衡化提高对比度
- 高斯滤波去噪
- 标准化图像尺寸

### 检测参数优化
- 人脸检测：`scale_factor=1.05, min_neighbors=6`
- 最小人脸尺寸：50x50像素
- 识别频率控制：每0.5秒识别一次

### 置信度控制
- LBPH置信度阈值：80（可调整）
- 低置信度结果标记为"Unknown"

## 🎯 系统功能说明

### 摄像头控制
- **启动摄像头**：开始视频流
- **停止摄像头**：停止视频流
- **开始识别**：启动人脸识别模式
- **停止识别**：停止人脸识别模式

### 用户管理
- **添加用户**：注册新用户并训练人脸模型
- **查看用户**：显示所有已注册用户

### 健康记录
- **添加健康记录**：记录用户的糖分摄入情况
- **查看健康记录**：查看历史健康数据

## 🐛 故障排除

### 常见问题

1. **摄像头无法打开**
   - 检查设备权限
   - 确认摄像头驱动正常
   - 尝试其他摄像头ID（0, 1, 2...）

2. **识别效果不佳**
   - 重新训练模型，增加样本数量
   - 确保训练样本质量（光线充足、角度多样）
   - 调整置信度阈值

3. **训练失败**
   - 检查样本数量（至少5个）
   - 确认人脸检测正常
   - 查看控制台错误信息

4. **dlib模型错误**
   - 先运行 `python download_models.py` 下载必要的模型文件

### 调试信息

系统会在控制台输出详细的调试信息：
- 人脸检测坐标
- 识别结果和置信度
- 训练进度和状态
- 数据库操作结果

## ⚠️ 注意事项

### 模型文件
1. **必须下载**：使用前必须先运行 `python download_models.py`
2. **文件大小**：模型文件约100MB，确保有足够存储空间
3. **网络要求**：需要稳定的网络连接下载模型文件

### 训练阶段
1. **光线充足**：确保训练环境光线良好
2. **角度多样**：收集不同角度的人脸样本
3. **表情自然**：包含不同的表情状态
4. **样本质量**：确保人脸清晰可见

### 识别阶段
1. **摄像头稳定**：避免剧烈晃动
2. **光线一致**：保持与训练时相似的光线条件
3. **人脸朝向**：尽量正面朝向摄像头

### 系统要求
- **操作系统**：Windows 10+ / Ubuntu 22.04+
- **Python版本**：3.7+
- **摄像头**：USB摄像头或内置摄像头
- **内存**：建议4GB以上
- **存储**：至少1GB可用空间（包含模型文件）

## 🔄 系统更新

### 增量训练
- 支持添加新用户而不影响现有模型
- 自动合并新旧训练数据
- 模型版本管理

### 数据备份
- 自动备份训练数据
- 支持模型回滚
- 数据完整性检查

## 📈 性能优化

- 识别频率控制减少系统负载
- 图像尺寸优化平衡速度和精度
- 多线程处理避免界面卡顿
- 内存使用优化

## 🛠️ 开发环境

- Python 3.7+
- OpenCV 4.5+
- PyQt5 5.15+
- dlib 19.24.2
- face-recognition 1.3.0
- 支持CUDA加速（可选）

## 🎉 使用建议

1. **首次使用**：先下载模型文件，再训练1-2个用户熟悉流程
2. **样本数量**：建议每人收集10-15个样本
3. **定期更新**：定期重新训练模型提高准确率
4. **数据备份**：定期备份数据库和模型文件

## 📞 技术支持

如果遇到问题，请检查：
1. 是否已下载模型文件
2. 依赖包是否正确安装
3. 摄像头是否正常工作
4. 系统环境是否符合要求
5. 错误日志信息

## 📄 许可证

本项目仅供学习和研究使用。

---

## 🔧 已修复的问题

### 1. 启动错误修复
- ✅ 修复了 `NameError: name 'time' is not defined` 错误
- ✅ 在 `ui/main_window.py` 中添加了缺失的 `time` 模块导入

### 2. 识别效果优化
- ✅ 优化了人脸检测参数，提高检测准确率
- ✅ 改进了图像预处理，添加直方图均衡化
- ✅ 增加了数据增强功能，提高训练质量
- ✅ 调整了置信度阈值设置
- ✅ 优化了人脸区域提取，增加边界确保完整性

### 3. 训练数据管理
- ✅ 修复了训练数据丢失问题
- ✅ 建立了完整的用户-图片-模型关联关系
- ✅ Qt界面的训练功能现在真正有效
- ✅ 支持多种训练方式（摄像头/目录）
